<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
  
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancelled Orders - {% if branding.name %}{{ branding.name }}{% else %}Mocha Cafe{% endif %}</title>

    <!-- Favicons -->
    <link href="{% static 'img/favicon.png' %}" rel="icon">
    <link href="{% static 'img/apple-touch-icon.png' %}" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,300i,400,400i,600,600i,700,700i|Satisfy|Comic+Neue:300,300i,400,400i,700,700i" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="{% static 'vendor/animate.css/animate.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/boxicons/css/boxicons.min.css' %}" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="{% static 'css/admin_dashboard.css' %}" rel="stylesheet">
    <link href="{% static 'css/delete_orders.css' %}" rel="stylesheet">
    <!-- Include Order Details Modal -->

    
   
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center py-4">
                        <h3>{% if branding.name %}{{ branding.name }}{% else %}Mocha Cafe{% endif %}</h3>
                        <p class="text-white-50">Admin Dashboard</p>
                        <hr class="mt-2 mb-4" style="border-color: rgba(255,255,255,0.1);">
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="{% url 'orders:admin_dashboard' %}">
                                <i class="bi bi-speedometer2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="{% url 'orders:orderList' %}">
                                <i class="bi bi-cart3"></i>
                                Orders
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="bi bi-trash"></i>
                                Cancelled Orders
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="{% url 'reservations:table_dashboard' %}">
                                <i class="bi bi-table"></i>
                                Tables
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="{% url 'reports:sales_report' %}">
                                <i class="bi bi-graph-up"></i>
                                Reports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/#menu">
                                <i class="bi bi-box"></i>
                                Menu Items
                            </a>
                        </li>
                        <li class="nav-item mt-4">
                            <a class="nav-link text-white" href="{% url 'users:logout' %}">
                                <i class="bi bi-box-arrow-right"></i>
                                Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="main-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="h4 mb-0">{{ page_title }}</h2>
                            <p class="mb-0 text-muted">Manage cancelled orders</p>
                        </div>
                        <div class="d-flex">
                            <div class="input-group search-container">
                                <input type="text" class="form-control form-control-sm" placeholder="Search orders...">
                                <button class="btn btn-sm btn-outline-secondary" type="button">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            <button class="btn btn-sm btn-outline-primary ms-2">
                                <i class="bi bi-download me-1"></i> Export
                            </button>
                        </div>
                    </div>
                </div>
                
                ---

                <div class="card-body p-3">
                    <form method="GET" id="filterForm">
                        <div class="row align-items-center">
                            <div class="col-md-4 mb-2 mb-md-0">
                                <label class="form-label small text-uppercase text-muted mb-1">Filter by Table</label>
                                <select name="table_number" class="form-select form-select-sm">
                                    <option value="">All Tables</option>
                                    {% for table in tables %}
                                    <option value="{{ table }}" {% if table == selected_table %}selected{% endif %}>{{ table }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-2 mb-md-0">
                                <label class="form-label small text-uppercase text-muted mb-1">Date</label>
                                <input type="date" name="date" class="form-control form-control-sm" value="{{ selected_date }}">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-sm btn-primary me-2">Apply Filters</button>
                                <a href="{% url 'orders:cancelled_orders' %}" class="btn btn-sm btn-outline-secondary">Reset</a>
                            </div>
                        </div>
                    </form>
                </div>
                
                ---

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-trash me-2"></i>
                            <span>Cancelled Orders List</span>
                            <span class="badge bg-light text-dark ms-2">{{ total_cancelled_orders }} orders</span>
                        </div>
                        <div class="text-muted small">
                            <i class="bi bi-info-circle me-1"></i>
                            Last updated: {% now "Y-m-d H:i" %}
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="deletedOrdersTable">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Table</th>
                                        <th>Order Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    {% for order in page_obj %}
                                    <tr>
                                        <td>#{{ order.id }}</td>
                                        <td>{{ order.table.number|default:"N/A" }}</td>
                                        <td>{{ order.ordered_at|date:"Y-m-d H:i A" }}</td>
                                        <td>{{ order.total_amount|floatformat:2 }} RWF</td>
                                        <td><span class="badge-cancelled">Cancelled</span></td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="action-button view-details" 
                                                        data-order-id="{{ order.id }}"
                                                        title="View Details">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="action-button" title="Change Status">
                                                    <i class="bi bi-list-check"></i>
                                                </button>
                                                <button class="action-button" title="Print">
                                                    <i class="bi bi-printer"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <i class="bi bi-inbox fs-1 d-block text-muted mb-2"></i>
                                            <span class="text-muted">No cancelled orders found</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                        <div class="small text-muted">
                            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ paginator.count }} orders
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                {% if page_obj.has_previous %}
                                    <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
                                {% else %}
                                    <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                                {% endif %}
                                
                                {% for i in page_obj.paginator.page_range %}
                                    {% if page_obj.number == i %}
                                        <li class="page-item active"><a class="page-link" href="#">{{ i }}</a></li>
                                    {% else %}
                                        <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                    <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
                                {% else %}
                                    <li class="page-item disabled"><a class="page-link" href="#">Next</a></li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                </div>
                
                ---

                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card border-start border-3 border-danger">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="text-uppercase text-muted small mb-1">Cancelled Orders</h6>
                                        <h4 class="mb-0">{{ total_cancelled_orders }}</h4>
                                    </div>
                                    <div class="icon bg-danger bg-opacity-10 text-danger p-3 rounded">
                                        <i class="bi bi-x-circle fs-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card border-start border-3 border-warning">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="text-uppercase text-muted small mb-1">Cancelled Amount</h6>
                                        <h4 class="mb-0">{{ total_cancelled_amount|floatformat:2 }} RWF</h4>
                                    </div>
                                    <div class="icon bg-warning bg-opacity-10 text-warning p-3 rounded">
                                        <i class="bi bi-currency-exchange fs-4"></i>
                                    </div>
                                </div>
                              
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card border-start border-3 border-primary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="text-uppercase text-muted small mb-1">Avg. Cancellation</h6>
                                        <h4 class="mb-0">{{ avg_cancellation_amount|floatformat:2 }} RWF</h4>
                                    </div>
                                    <div class="icon bg-primary bg-opacity-10 text-primary p-3 rounded">
                                        <i class="bi bi-calculator fs-4"></i>
                                    </div>
                                </div>
                               
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
        
        // View details buttons
        document.querySelectorAll('.view-details').forEach(button => {
            button.addEventListener('click', function() {
                // Call the loadOrderDetails function from the included modal file
                const orderId = this.getAttribute('data-order-id');
                loadOrderDetails(orderId);
            });
        });
        
        // The rest of your JavaScript for loading cancelled orders can remain
        function loadCancelledOrders() {
            const searchTerm = document.getElementById('searchInput').value;
            const tableFilter = document.querySelector('select[name="table_number"]').value;
            const dateFilter = document.querySelector('input[name="date"]').value;
            
            fetch(`?ajax=1&table_number=${tableFilter}&date=${dateFilter}&search=${searchTerm}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(orders => {
                const tbody = document.getElementById('ordersTableBody');
                let html = '';
                
                if (orders.length === 0) {
                    html = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="bi bi-inbox fs-1 d-block text-muted mb-2"></i>
                                <span class="text-muted">No cancelled orders found</span>
                            </td>
                        </tr>
                    `;
                } else {
                    orders.forEach(order => {
                        html += `
                            <tr>
                                <td>#${order.id}</td>
                                <td>${order.table_number || 'N/A'}</td>
                                <td>${new Date(order.ordered_at).toLocaleString()}</td>
                                <td>${order.total_amount} RWF</td>
                                <td><span class="badge-cancelled">Cancelled</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-button view-details" 
                                                data-order-id="${order.id}"
                                                title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="action-button" title="Change Status">
                                            <i class="bi bi-list-check"></i>
                                        </button>
                                        <button class="action-button" title="Print">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                tbody.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

       
    </script>
     {% include 'includes/order_details_modal.html' %}
</body>
</html>